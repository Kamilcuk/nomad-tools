---
on:
  - push
jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: test
        run: |
          set -x
          sudo mkdir -vp /opt/cni
          sudo ln -sv /usr/lib/cni /opt/cni/bin
          for i in /opt/cni/bin/*; do
            "$i" --help || true
            "$i" --version || true
          done
          apt list -a containernetworking-plugins
          v=https://releases.hashicorp.com/nomad/1.8.0/nomad_1.8.0_linux_amd64.zip
          wget -q "$v"
          unzip *.zip
          export PATH=$PWD:$PATH
          chmod +x ./nomad
          nomad --version
          sudo ./nomad agent -dev &
          sleep 10
          exec 0<&-
          nomad operator api /v1/nodes |
            jq -r '.[].ID' |
            xargs -t -i nomad operator api /v1/node/{} |
            jq
          sudo killall nomad
          sleep 10
          exit 1
